From 61db31468fb19ed34984d46c1838a3c280bbea05 Mon Sep 17 00:00:00 2001
From: Dominik del Bondio <dominik.del.bondio@bitextender.com>
Date: Wed, 3 May 2017 02:39:19 +0200
Subject: [PATCH] Fixes builds for debian/ubuntu based images (#480) (#481)

---
 container/core.py                                  | 16 +++++++++++++++-
 container/docker/templates/conductor-dockerfile.j2 |  2 +-
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/container/core.py b/container/core.py
index 9d4e853..5b4c401 100644
--- a/container/core.py
+++ b/container/core.py
@@ -669,9 +669,23 @@ def conductorcmd_build(engine_name, project_name, services, cache=True,
                 )
 
                 if not local_python:
+                    # If we're on a debian based distro, we need the correct architecture
+                    # to allow python to load dynamically loaded shared libraries
+                    extra_library_paths = ''
+                    try:
+                        architecture = subprocess.check_output(['dpkg-architecture',
+                                                                   '-qDEB_HOST_MULTIARCH'])
+                        architecture = architecture.strip()
+                        logger.debug(u'Detected architecture %s', architecture,
+                                       service=service_name, architecture=architecture)
+                        extra_library_paths = ':/_usr/lib/{0}:/_usr/local/lib/{0}'.format(architecture)
+                    except Exception:
+                        # we're not on debian/ubuntu or a system without multiarch support
+                        pass
+
                     # Use the conductor's Python runtime
                     run_kwargs['environment'] = dict(
-                         LD_LIBRARY_PATH='/_usr/lib:/_usr/lib64:/_usr/local/lib',
+                         LD_LIBRARY_PATH='/_usr/lib:/_usr/lib64:/_usr/local/lib{}'.format(extra_library_paths),
                          CPATH='/_usr/include:/_usr/local/include',
                          PATH='/usr/local/sbin:/usr/local/bin:'
                               '/usr/sbin:/usr/bin:/sbin:/bin:'
diff --git a/container/docker/templates/conductor-dockerfile.j2 b/container/docker/templates/conductor-dockerfile.j2
index 7c53c92..ca6d340 100644
--- a/container/docker/templates/conductor-dockerfile.j2
+++ b/container/docker/templates/conductor-dockerfile.j2
@@ -12,7 +12,7 @@ RUN yum update -y && \
     yum clean all
 {% elif distro in ["debian", "ubuntu"] %}
 RUN apt-get update -y && \
-    apt-get install -y gcc python2.7 git python-dev rsync libffi-dev libssl-dev python-apt && \
+    apt-get install -y gcc python2.7 git python-dev rsync libffi-dev libssl-dev dpkg-dev python-apt && \
     cd /usr/bin && \
     rm -f lsb_release && \
     ln -fs python2.7 python && \
